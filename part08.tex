\section{Простые числа}
Проверка чисел на простоту.
Числа Кармайкла, малая теорема Ферма.
Генерация случайных простых чисел.
Криптография: схемы с закрытым ключом, RSA.
Необходимые факты теории чисел.

\subsection{Тесты}
\begin{theorem}[Малая теорема Ферма]
    Если $p$ --- простое, и $1 \leq a < p$, то
    \[ a^{p - 1} \equiv 1 \pmod p \]
\end{theorem}
\begin{proof}
    Рассмотрим множество ненулевых остатков от деления на $p$:
    $\{1, \ldots, p - 1\}$.
    При умножении любого из них на $a$ мы получим
    остаток из этого же множества.
    При этом никакие два умножения не дадут один результат,
    т.к. если
    $an \equiv am \pmod p$,
    то $a(n - m) \equiv 0 \pmod p$,
    следовательно, $n = m$.

    Тогда
    \[
        \{1, \ldots, p - 1\}
        = \{ a \cdot 1 \Mod p, \ldots, a \cdot (p - 1) \Mod p \}
    \]

    Перемножим все элементы этого множества:
    \begin{gather*}
        (p - 1)! \equiv a^{p - 1} \cdot (p - 1)! \pmod p \\
        \gcd((p - 1)!, p) = 1 \\
        (p - 1)! \cdot (a^{p - 1} - 1) \equiv 0 \pmod p \\
        a^{p - 1} \equiv 1 \pmod p
    \end{gather*}
\end{proof}

Быстрая проверка на простоту --- тест Ферма:
проверить, подходит ли число под малую лемму Ферма.

\begin{theorem}
    Если $\exists a \mid a^{m - 1} \not \equiv 1 \pmod m \land \gcd(a, m) = 1$,
    то чисел, не проходящих тест, хотя бы половина.
\end{theorem}
\begin{proof}
    Возьмём любое $b \mid b^{m - 1} \equiv 1 \pmod m$.
    Рассмотрим $ab$:
    \[
        (ab)^{m - 1}
        \equiv a^{m - 1} \cdot b^{m - 1}
        \equiv a^{m - 1} \not \equiv 1 \pmod m
    \]

    При этом если $c \ne b, c^{m - 1} \equiv 1 \pmod m$,
    то $ab \ne ac$, т.к. $a$ обратимо.
\end{proof}

Поэтому для случайно взятого $1 < a < m$
шанс ошибки в тесте Ферма не превышает $1/2$,
если число вообще может быть отсеяно этим тестом.

\begin{definition}
    Числа Кармайкла --- составные числа,
    которые всегда проходят тест Ферма.
\end{definition}
Чисел Кармайкла мало: $561 = 3 \cdot 11 \cdot 17$
проходит тест Ферма для всех $a$, взаимно простых с собой.

Тест Рабина-Миллера:
пусть $N$ --- нечётное.
Представим $N - 1 = 2^t \cdot u$,
где $u$ --- нечётное.
Выберем случайное $a$,
вычислим $a^{N - 1} \Mod N$.
Найдём первую единицу в последовательности
\[
    a^u \Mod N,
    a^{2u} \Mod N,
    a^{4u} \Mod N, \ldots,
    a^{N - 1} \Mod N
\]
(а если прошли тест Ферма, то она есть),
посмотрим на предыдущее число.
Если оно не является минус единицей,
то это нетривиальный корень из 1,
и, следовательно, $N$ составное.

Тест Рабина-Миллера с вероятностью $3/4$ обнаруживает
любое составное число, в т.ч. числа Кармайкла.

\subsection{Генерация простых чисел}
Число из $n$ битов имеет вероятность
$\approx 1/(\ln 2^n) \approx 1.44/n$
быть простым.

\begin{theorem}[Закон распределения простых чисел]
    Пусть $\pi(x)$ --- количество простых чисел,
    не превосходящих $x$.
    Тогда
    \[ \lim_{x \to \infty} \frac{\pi(x) \cdot \ln x}{x} = 1 \]
\end{theorem}

Поэтому для генерации простых чисел достаточно
генерировать $n$ бит и проверять на простоту.
На практике теста Ферма для
$a = 2$ достаточно,
но можно и добавить $a = 3, 5, 7, \ldots$.
Среднее количество попыток будет $n$.

Доказательство --- численный эксперимент.
Из первых $25 \cdot 10^9$ чисел
будет $\approx 10^9$ простых
и $\approx 2 \cdot 10^4$ составных,
т.е. шанс ошибки --- $0.002\%$.

\subsection{RSA}
Алиса хочет послать Бобу сообщение,
Боб посылает Алисе открытый ключ,
которым Алиса сможет зашифровать сообщение,
чтобы только Боб мог его расшифровать.
Алгоритм RSA основывается на предположении,
что факторизация числа --- сложная задача.

\begin{theorem}
    Если $p$ и $q$ простые,
    $M = (p - 1) (q - 1)$
    а $e$ взаимно просто
    с $M$, то:
    \begin{enumerate}
        \item Отображение $x \to x^e \mod pq$
        --- перестановка остатков по модулю $pq$
        \item Обратной перестановкой будет $x \to x^d \mod M$,
        где $e \cdot d \equiv 1 \pmod{M}$.
        То есть $(x^e)^d \equiv x \pmod{pq}$.
    \end{enumerate}
\end{theorem}
\begin{proof}
    Достаточно доказать второе утверждение,
    т.к. если есть обратное отображение, то само отображение --- перестановка.
    Очевидно, $d$ существует, поскольку $\gcd(e, M) = 1$.
    Возьмём $d = e^{-1} \pmod{M}$.
    $ed = 1 + k(p - 1)(q - 1)$.

    По малой теореме Ферма
    $x^{p - 1} \equiv 1 \pmod p$ при $x \ne 0$, поэтому
    \[ x^{1 + k(p - 1)(q - 1)} \equiv x \pmod p \]
    Аналогично $x^{ed} \equiv x \pmod q$.

    Поскольку $\gcd(p, q) = 1$,
    то $x^{ed} \equiv x \pmod{pq}$.
\end{proof}

Тогда можно опубликовать пару $\langle pq; e \rangle$
как \emph{открытый ключ}, и держать $\langle pq; d \rangle$
как \emph{закрытый ключ}.
Тогда
\begin{gather*}
    E(x) = x^e \Mod pq \\
    D(y) = y^d \Mod pq \\
    D(E(x)) = (x^e \Mod pq)^d \Mod pq = (x^e)^d \Mod pq = x
\end{gather*}

Часто берут $e = 3$.
