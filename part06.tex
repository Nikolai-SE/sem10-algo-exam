\section{Универсальные семейства хеш-функций}
Построение универсального семейства для
целочисленных ключей и для строк.
Оценка времени поиска в хеш-таблице
при использовании метода цепочек для универсального семейства.
Совершенное хеширование с помощью
универсального семейства хеш-функций.

\subsection{Конспект}
Множество функций $\cH$
из множества ключей $\mathcal{K}$
в $\{0, \ldots, m - 1\}$
называется
\emph{универсальным семейством хеш-функций},
если для любой пары различных ключей
$k_1$ и $k_2$
\[ \Pr_{h \in \cH} \brackets{h(k_1) = h(k_2)} \le \frac{1}{m} \]
(хеш-функция случайно выбирается один раз)

\begin{theorem}
    Среднее время безуспешного поиска в хеш-таблице при
    универсальном хешировании составляет $\Theta(1 + \alpha)$.
\end{theorem}
\begin{proof}
    \[
        X(i) =
        \begin{cases}
            1 & h(k_i) = h(k) \\
            0 & h(k_i) \ne h(k) \\
        \end{cases}
    \]

    По определению универсального семейства,
    и поскольку $k$ отсутствует в хеш-таблице
    $\E_h(X(i)) \le 1 / m$.

    Поэтому
    \begin{gather*}
        \E \brackets{\sum_{i=1}^n X(i)}
        = \sum_{i=1}^n \E X(i)
        \le \frac{n}{m} = \alpha
    \end{gather*}

    Хотя бы одно действие мы точно произведём,
    поэтому $\Theta(1 + \alpha)$.
\end{proof}

\begin{theorem}
    Среднее время успешного поиска в хеш-таблице при
    универсальном хешировании составляет $\Theta(1 + \alpha)$.
\end{theorem}
\begin{proof}
    Аналогично безуспешному поиску,
    но однин из $X(i)$ будет строго 1,
    поэтому
    \begin{gather*}
        \E \brackets{\sum_{i=1}^n X(i)}
        = \sum_{i=1}^n \E X(i)
        \le 1 + \frac{n - 1}{m} \in \Theta(1 + \alpha)
    \end{gather*}
\end{proof}

\subsection{Пример}
\begin{theorem}
    Путь $K = \{0, \ldots, n\}$.
    Выберем простое $p > n$.
    Тогда семейство $\cH$,
    состоящее из функций
    \[ h_{a, b}(k) = \Bigl( (ak + b) \Mod p \Bigr) \Mod m \]
    для $a = 1, \ldots, p - 1$ и $b = 0, \ldots, p - 1$
    будет универсальным.
\end{theorem}
\begin{proof}
    Рассмотрим $k_1 \ne k_2$.
    \begin{align*}
        & t_1 = (ak_1 + b) \Mod p &
        & t_2 = (ak_2 + b) \Mod p \\
    \end{align*}

    Т.к. $k_1 \ne k_2$, то $t_1 \ne t_2$.
    Если предположить, что $t_1 = t_2$,
    то
    \begin{gather*}
        ak_1 + b \equiv ak_2 + b \pmod{p} \\
        a(k_1 - k_2) \equiv 0 \pmod{p} \\
        a \ne 0 \Rightarrow k_1 = k_2
    \end{gather*}

    По $t_1, t_2, k_1, k_2$ можно однозначно восстановить $a, b$:
    \begin{gather*}
        t_1 - t_2 \equiv a(k_1 - k_2) \pmod{p} \\
        a \equiv (t_1 - t_2) \cdot (k_1 - k_2)^{-1} \pmod{p} \\
        b \equiv t_1 - a k_1 \pmod{p}
    \end{gather*}
    (кольцо по модулю $p$ --- поле, в нём есть деление).

    При всех возможных парах $a, b$
    каждая пара $t_1, t_2$ встречается ровно один раз.
    Тогда если выбирать $h_{a, b}$ случайно и равномерно из $\cH$,
    то пары $t_1, t_2$ будут случайно и равномерно
    распределены на $\{0, \ldots, p - 1\}$,
    при этом $t_1 \ne t_2$.

    Тогда вероятность того, что хеш-коды ключей совпадут,
    равна вероятности того, что два различных числа
    из $\{0, \ldots, p - 1\}$ окажутся равны по модулю $m$.
    Для фиксированного $t_1$ количество таких $t_2$ не превосходит
    \[
        \ceil{\frac{p}{m}} - 1
        \le \frac{p + m - 1}{m} - 1
        = \frac{p - 1}{m}
    \]

    Тогда вероятность получить коллизию равна
    \[
        \frac{1}{p} \cdot \frac{p - 1}{m} \le \frac{1}{m}
    \]
\end{proof}

\subsection{Совершенное хеширование}
Хотим для статического поиска иметь
поиск за строгое $\O(1)$
и $\O(n)$ памяти.
Для этого будем использовать таблицы второго уровня
с разными хеш-функциями вместо списков.
Скажем, что $n_i$ --- число ключей,
попавших в $i$-ю первичную ячейку.

\begin{theorem}
    \label{thm:06-1}
    При использовании универсального хеширования
    для хеш-таблицы размера $m = n^2$ вероятность
    возникновения коллизий не более $1/2$.
\end{theorem}
\begin{proof}
    Мат. ожидание количества коллизий
    \[
        \E X \le \binom{n}{2} \cdot \frac{1}{m}
        = \frac{n(n - 1)}{2} \cdot \frac{1}{n^2} < \frac{1}{2}
    \]

    По неравенству Маркова
    \[
        \Pr \brackets{X \geq 1} \le \frac{\E X}{1}
        < \frac{1}{2}
    \]
\end{proof}

\begin{theorem}
    \label{thm:06-2}
    При $m = n$
    \[
        \Pr \brackets{\sum_{i=0}^{n-1} n_i^2 \geq 4n} \le \frac{1}{2}
    \]
\end{theorem}
\begin{proof}
    Покажем, что
    \[
        \E \brackets{\sum_{i=0}^{n-1} n_i^2} < 2n
    \]

    \begin{gather*}
        n_i^2 = n_i + 2 \binom{n_i}{2} \\
        \E \brackets{\sum_{i=0}^{n-1} n_i^2}
        = \E \brackets{\sum_{i=0}^{n-1} n_i + 2 \sum_{i=0}^{n-1} \binom{n_i}{2}}
        = n + 2 \E \brackets{\sum_{i=0}^{n-1} \binom{n_i}{2}} \le \\
        \brackets{\text{вероятность коллизии не превосходит $1/m = 1/n$}} \\
        \le n + 2 \binom{n}{2} \cdot \frac{1}{n}
        = n + 2 \cdot \frac{n (n - 1)}{2} \cdot \frac{1}{n}
        = n + n - 1 < 2n
    \end{gather*}

    \[
        \Pr \brackets{\sum_{i=0}^{n-1} n_i^2 \geq 4n}
        \le \frac{\E \brackets{\sum_{i=0}^{n-1} n_i^2}}{4n}
        < \frac{2n}{4n} = \frac{1}{2}
    \]
\end{proof}

Тогда вероятностный алгоритм
построения совершенной хеш-таблицы:
\begin{enumerate}
    \item Построим хеш-таблицу $H$ и выберем хеш-функцию
    $h : K \to \{0, \ldots, m - 1\}$
    так, чтобы $\sum_{i=0}^{n-1} n_i^2 < 4n$.
    Для этого по теореме~\ref{thm:06-2} в среднем потребуется
    проверить не более двух хеш-функций.

    \item Когда такая $h$ найдена, для каждой $i$-й ячейки $H$
    заводим хеш-таблицу $T_i$ размера $n_i^2$
    и выбираем для неё хеш-функцию $g_i : K \to \{0, \ldots, n^2 - 1\}$
    так, чтобы у неё не было коллизий на множестве ключей,
    для которых $h(k) = i$.
    Для этого по теореме~\ref{thm:06-1} в среднем потребуется
    проверить не более двух хеш-функций.
\end{enumerate}

Полученный алгоритм построения работает за $\O(n)$,
требует $\O(n)$ памяти и даёт поиск за строгие $\O(1)$.
